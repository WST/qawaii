# План разработки приложения Qawaii (Qt Notes Manager)

## Текущий статус проекта

**Последнее обновление:** 2024-12-02

### Статус сборки
✅ **Проект успешно компилируется!**

Проект был успешно собран с использованием CMake и Qt6. Все базовые компоненты созданы и готовы к дальнейшей разработке.

### Выполненные этапы
- ✅ **Этап 1**: Базовая структура проекта (100%)
- ⚠️ **Этап 2**: Модели данных (67% - классы созданы, сериализация не реализована)
- ⚠️ **Этап 3**: Интерфейс драйвера хранилища (67% - интерфейс создан, фабрики нет)
- ✅ **Этап 4**: Реализация SQLite драйвера (100% - полностью реализован)
- ⚠️ **Этап 6**: Сервисы (75% - сервисы созданы, интеграция не завершена)
- ⚠️ **Этап 7**: Базовый UI (75% - структура создана, функциональность не реализована)

### Следующие шаги
1. Интеграция SQLite драйвера с NotesManager
2. Реализация функциональности UI компонентов (отображение заметок и папок)
3. Реализация MySQL драйвера (Этап 5)
4. Добавить тесты для MySQL драйвера

---

## Архитектура приложения

### Общая структура

Приложение построено на принципах разделения ответственности (Separation of Concerns) и использования паттернов проектирования:

1. **Слой данных (Data Layer)**
   - Абстрактный интерфейс драйвера хранилища
   - Конкретные реализации драйверов (SQLite, MySQL)
   - Модели данных (Note, Folder)

2. **Слой бизнес-логики (Business Logic Layer)**
   - Менеджер заметок (NotesManager)
   - Сервис синхронизации (SyncService)
   - Сервис миграции данных (MigrationService)

3. **Слой представления (Presentation Layer)**
   - Главное окно (MainWindow)
   - Виджеты для отображения заметок и папок
   - Диалоги настроек
   - Редактор заметок с поддержкой Markdown

### Структура директорий проекта

```
qawaii/
├── CMakeLists.txt              # Основной файл сборки
├── src/
│   ├── main.cpp                # Точка входа
│   ├── core/                   # Ядро приложения
│   │   ├── models/             # Модели данных
│   │   │   ├── Note.h/cpp
│   │   │   └── Folder.h/cpp
│   │   ├── storage/            # Драйверы хранилища
│   │   │   ├── StorageDriver.h # Абстрактный интерфейс
│   │   │   ├── SQLiteDriver.h/cpp
│   │   │   └── MySQLDriver.h/cpp
│   │   └── services/           # Бизнес-логика
│   │       ├── NotesManager.h/cpp
│   │       ├── SyncService.h/cpp
│   │       └── MigrationService.h/cpp
│   ├── ui/                     # UI компоненты
│   │   ├── MainWindow.h/cpp
│   │   ├── widgets/
│   │   │   ├── NotesTreeWidget.h/cpp    # Сайдбар с деревом заметок
│   │   │   ├── NoteEditorWidget.h/cpp   # Редактор заметок
│   │   │   └── MarkdownViewer.h/cpp     # Просмотр Markdown
│   │   └── dialogs/
│   │       ├── SettingsDialog.h/cpp
│   │       ├── DriverSettingsWidget.h/cpp
│   │       └── IconSelectionDialog.h/cpp
│   └── utils/                  # Утилиты
│       └── MarkdownParser.h/cpp
├── resources/                  # Ресурсы
│   ├── icons/                  # Иконки для заметок и папок
│   └── translations/           # Файлы локализации (.ts)
│       ├── qawaii_ru.ts
│       └── qawaii_en.ts
├── tests/                      # Тесты (опционально)
└── plan.md                     # Этот файл
```

## Детальная архитектура компонентов

### 1. Модели данных

#### Folder (Папка)
```cpp
class Folder {
    QString id;              // Уникальный идентификатор
    QString name;            // Имя папки
    QString iconName;        // Имя иконки (фиксированное)
    QDateTime createdAt;
    QDateTime modifiedAt;
    QList<Note*> notes;      // Список заметок в папке
};
```

#### Note (Заметка)
```cpp
class Note {
    QString id;              // Уникальный идентификатор
    QString folderId;        // ID родительской папки
    QString title;           // Заголовок заметки
    QString content;         // Содержимое (Markdown)
    QString iconName;        // Имя иконки (выбираемая)
    QDateTime createdAt;
    QDateTime modifiedAt;
    QString version;         // Версия для синхронизации
};
```

### 2. Интерфейс драйвера хранилища

#### StorageDriver (Абстрактный класс)
```cpp
class StorageDriver {
public:
    virtual ~StorageDriver() = default;
    
    // Инициализация и подключение
    virtual bool initialize(const QVariantMap& config) = 0;
    virtual bool connect() = 0;
    virtual void disconnect() = 0;
    virtual bool isConnected() const = 0;
    
    // Работа с папками
    virtual QList<Folder*> getFolders() = 0;
    virtual Folder* createFolder(const QString& name) = 0;
    virtual bool updateFolder(Folder* folder) = 0;
    virtual bool deleteFolder(const QString& folderId) = 0;
    
    // Работа с заметками
    virtual QList<Note*> getNotes(const QString& folderId) = 0;
    virtual Note* createNote(const QString& folderId, const QString& title) = 0;
    virtual bool updateNote(Note* note) = 0;
    virtual bool deleteNote(const QString& noteId) = 0;
    virtual Note* getNote(const QString& noteId) = 0;
    
    // Синхронизация (для сетевых хранилищ)
    virtual bool sync() = 0;
    
    // Метаданные драйвера
    virtual QString driverName() const = 0;
    virtual QString driverType() const = 0; // "local", "network", "cloud"
    virtual QVariantMap getDefaultConfig() const = 0;
    virtual QStringList getConfigKeys() const = 0; // Ключи настроек
    
    // Транзакции (опционально)
    virtual bool beginTransaction() = 0;
    virtual bool commitTransaction() = 0;
    virtual bool rollbackTransaction() = 0;
};
```

### 3. Реализации драйверов

#### SQLiteDriver
- Хранит данные в локальном SQLite файле
- Таблицы: `folders`, `notes`
- Настройки: `database_path` (путь к файлу БД)
- Тип: "local"

#### MySQLDriver
- Хранит данные в MySQL базе данных
- Таблицы: `folders`, `notes`
- Настройки: `host`, `port`, `username`, `password`, `database_name`
- Тип: "network"

### 4. Сервисы

#### NotesManager
- Управляет жизненным циклом заметок и папок
- Работает через абстрактный интерфейс StorageDriver
- Кэширует данные в памяти для быстрого доступа
- Уведомляет UI об изменениях через сигналы Qt

#### SyncService
- Выполняет синхронизацию с хранилищем
- Поддерживает принудительную синхронизацию
- Обрабатывает конфликты версий (для сетевых хранилищ)

#### MigrationService
- Выполняет миграцию данных между драйверами
- Экспортирует данные из текущего драйвера
- Импортирует данные в новый драйвер
- Сохраняет целостность данных

### 5. UI компоненты

#### MainWindow
- Главное окно приложения
- Содержит меню, тулбар, сайдбар и контент-панель
- Управляет состоянием приложения

#### NotesTreeWidget
- Отображает дерево папок и заметок
- Поддерживает drag & drop
- Контекстное меню для удаления
- Выбор иконок для заметок

#### NoteEditorWidget
- Редактор заметок с поддержкой Markdown
- Разделение на режимы: редактирование и просмотр
- Автосохранение при изменении

#### SettingsDialog
- Настройки приложения
- Выбор и настройка драйвера
- Миграция между драйверами
- Локализация

## Пошаговый план разработки

### Этап 1: Базовая структура проекта ✅
- [x] Создать структуру директорий
- [x] Настроить CMakeLists.txt для Qt проекта
- [x] Создать базовое приложение с главным окном
- [x] Настроить систему локализации Qt (tr(), .ts файлы)

### Этап 2: Модели данных ⚠️ (частично)
- [x] Реализовать класс Folder
- [x] Реализовать класс Note
- [ ] Добавить сериализацию/десериализацию (QVariant, JSON)

### Этап 3: Интерфейс драйвера хранилища ⚠️ (частично)
- [x] Создать абстрактный класс StorageDriver
- [x] Определить все виртуальные методы
- [ ] Добавить фабрику драйверов (DriverFactory)

### Этап 4: Реализация SQLite драйвера ✅
- [x] Реализовать SQLiteDriver
- [x] Создать схему БД (таблицы folders и notes)
- [x] Реализовать все методы интерфейса
- [x] Использовать QStandardPaths для каноничного пути к БД (~/.config/qawaii/notes.db)
- [ ] Протестировать базовые операции CRUD (требуется интеграция с UI)

### Этап 5: Реализация MySQL драйвера
- [ ] Реализовать MySQLDriver
- [ ] Создать схему БД
- [ ] Реализовать все методы интерфейса
- [ ] Добавить обработку ошибок подключения

### Этап 6: Сервисы ⚠️ (частично)
- [x] Реализовать NotesManager
- [x] Реализовать SyncService
- [x] Реализовать MigrationService
- [ ] Интегрировать сервисы с драйверами

### Этап 7: Базовый UI ⚠️ (частично)
- [x] Создать MainWindow с меню и тулбаром
- [x] Реализовать NotesTreeWidget (сайдбар) - базовая структура
- [x] Реализовать NoteEditorWidget (контент-панель) - базовая структура
- [ ] Добавить базовые действия (создание папки/заметки) - заглушки созданы

### Этап 8: Интеграция UI и логики
- [ ] Подключить NotesManager к UI
- [ ] Реализовать отображение заметок и папок
- [ ] Добавить редактирование заметок
- [ ] Реализовать автосохранение

### Этап 9: Расширенный функционал
- [ ] Добавить поддержку Markdown (парсинг и отображение)
- [ ] Реализовать выбор иконок для заметок
- [ ] Добавить контекстное меню с удалением
- [ ] Реализовать диалог подтверждения удаления

### Этап 10: Настройки и миграция
- [ ] Создать SettingsDialog
- [ ] Реализовать виджеты настроек для каждого драйвера
- [ ] Добавить выбор драйвера
- [ ] Реализовать миграцию данных между драйверами

### Этап 11: Синхронизация
- [ ] Добавить кнопку принудительной синхронизации
- [ ] Реализовать индикатор синхронизации
- [ ] Добавить обработку ошибок синхронизации

### Этап 12: Локализация
- [ ] Перевести все строки на русский язык
- [ ] Создать .ts файлы для локализации
- [ ] Настроить автоматическую генерацию переводов
- [ ] Протестировать переключение языков

### Этап 13: Полировка и тестирование ⚠️ (частично)
- [x] Добавить базовые тесты для SQLite драйвера (18 тестов, все проходят)
- [x] Настроить CTest для автоматического запуска тестов
- [ ] Добавить тесты для MySQL драйвера
- [ ] Добавить тесты для NotesManager
- [ ] Добавить обработку ошибок во всех компонентах
- [ ] Улучшить UX (подсказки, валидация)
- [ ] Оптимизировать производительность
- [ ] Протестировать все сценарии использования

## Технические детали

### Используемые технологии
- **Qt Framework**: 6.x (или 5.x, в зависимости от требований)
- **CMake**: Система сборки
- **Qt Test**: Фреймворк для модульного тестирования
- **SQLite**: Локальное хранилище
- **MySQL**: Сетевое хранилище (через Qt SQL)
- **Markdown**: Форматирование заметок (возможно, библиотека вроде CommonMark)

### Кодировка
- Все строки в UTF-8
- Базы данных с кодировкой UTF-8
- Файлы локализации в UTF-8

### Паттерны проектирования
- **Strategy Pattern**: Для драйверов хранилища
- **Factory Pattern**: Для создания драйверов
- **Observer Pattern**: Сигналы/слоты Qt для уведомлений
- **Repository Pattern**: NotesManager как репозиторий данных

### Будущие расширения
Архитектура предусматривает легкое добавление:
- WebDAV драйвера (для синхронизации через WebDAV)
- REST API драйвера (для облачных хранилищ)
- Дополнительных форматов заметок (HTML, RTF)
- Тегов и поиска
- Экспорта/импорта заметок

## Примечания

- Все коммиты делает пользователь самостоятельно
- Проект экспериментальный, без подключения к удаленным репозиториям
- При разработке следует придерживаться принципов SOLID
- Код должен быть документирован (комментарии на русском языке)

